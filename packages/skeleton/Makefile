sysroot:
	$(STEP) "host-skeleton-init-common"
	mkdir -pv $(TOOLS_DIR)/$(CONFIG_TARGET)/sysroot/dev
	mkdir -pv $(TOOLS_DIR)/$(CONFIG_TARGET)/sysroot/etc
	mkdir -pv $(TOOLS_DIR)/$(CONFIG_TARGET)/sysroot/media
	mkdir -pv $(TOOLS_DIR)/$(CONFIG_TARGET)/sysroot/mnt
	mkdir -pv $(TOOLS_DIR)/$(CONFIG_TARGET)/sysroot/opt
	mkdir -pv $(TOOLS_DIR)/$(CONFIG_TARGET)/sysroot/proc
	mkdir -pv $(TOOLS_DIR)/$(CONFIG_TARGET)/sysroot/root
	mkdir -pv $(TOOLS_DIR)/$(CONFIG_TARGET)/sysroot/run
	mkdir -pv $(TOOLS_DIR)/$(CONFIG_TARGET)/sysroot/sys
	mkdir -pv $(TOOLS_DIR)/$(CONFIG_TARGET)/sysroot/tmp
	mkdir -pv $(TOOLS_DIR)/$(CONFIG_TARGET)/sysroot/usr
	ln -svf /proc/self/fd $(TOOLS_DIR)/$(CONFIG_TARGET)/sysroot/dev/fd
	ln -svf /proc/self/fd/2 $(TOOLS_DIR)/$(CONFIG_TARGET)/sysroot/dev/stderr
	ln -svf /proc/self/fd/0 $(TOOLS_DIR)/$(CONFIG_TARGET)/sysroot/dev/stdin
	ln -svf /proc/self/fd/1 $(TOOLS_DIR)/$(CONFIG_TARGET)/sysroot/dev/stdout
	cp -v $(PACKAGES_DIR)/skeleton/etc/group $(TOOLS_DIR)/$(CONFIG_TARGET)/sysroot/etc
	cp -v $(PACKAGES_DIR)/skeleton/etc/hosts $(TOOLS_DIR)/$(CONFIG_TARGET)/sysroot/etc
	cp -v $(PACKAGES_DIR)/skeleton/etc/passwd $(TOOLS_DIR)/$(CONFIG_TARGET)/sysroot/etc
	cp -v $(PACKAGES_DIR)/skeleton/etc/profile $(TOOLS_DIR)/$(CONFIG_TARGET)/sysroot/etc
	cp -v $(PACKAGES_DIR)/skeleton/etc/protocols $(TOOLS_DIR)/$(CONFIG_TARGET)/sysroot/etc
	cp -v $(PACKAGES_DIR)/skeleton/etc/services $(TOOLS_DIR)/$(CONFIG_TARGET)/sysroot/etc
	cp -v $(PACKAGES_DIR)/skeleton/etc/shadow $(TOOLS_DIR)/$(CONFIG_TARGET)/sysroot/etc
	ln -svf /proc/self/mounts $(TOOLS_DIR)/$(CONFIG_TARGET)/sysroot/etc/mtab
	mkdir -v $(TOOLS_DIR)/$(CONFIG_TARGET)/sysroot/etc/profile.d
	cp -v $(PACKAGES_DIR)/skeleton/etc/profile.d/umask.sh $(TOOLS_DIR)/$(CONFIG_TARGET)/sysroot/etc/profile.d
	ln -svf /tmp/resolv.conf $(TOOLS_DIR)/$(CONFIG_TARGET)/sysroot/etc/resolv.conf
	mkdir -pv $(TOOLS_DIR)/$(CONFIG_TARGET)/sysroot/usr/bin
	mkdir -pv $(TOOLS_DIR)/$(CONFIG_TARGET)/sysroot/usr/lib
	mkdir -pv $(TOOLS_DIR)/$(CONFIG_TARGET)/sysroot/usr/sbin
	install -d -m 0755 $(TOOLS_DIR)/$(CONFIG_TARGET)/sysroot/bin
	install -d -m 0755 $(TOOLS_DIR)/$(CONFIG_TARGET)/sysroot/sbin
	install -d -m 0755 $(TOOLS_DIR)/$(CONFIG_TARGET)/sysroot/lib
	ln -snf lib $(TOOLS_DIR)/$(CONFIG_TARGET)/sysroot/lib64
	ln -snf lib $(TOOLS_DIR)/$(CONFIG_TARGET)/sysroot/usr/lib64
	install -d -m 0755 $(TOOLS_DIR)/$(CONFIG_TARGET)/sysroot/usr/include

system:
	$(STEP) "skeleton-init-common"
	mkdir -pv $(ROOTFS_DIR)/dev
	mkdir -pv $(ROOTFS_DIR)/etc
	mkdir -pv $(ROOTFS_DIR)/media
	mkdir -pv $(ROOTFS_DIR)/mnt
	mkdir -pv $(ROOTFS_DIR)/opt
	mkdir -pv $(ROOTFS_DIR)/proc
	mkdir -pv $(ROOTFS_DIR)/root
	mkdir -pv $(ROOTFS_DIR)/run
	mkdir -pv $(ROOTFS_DIR)/sys
	mkdir -pv $(ROOTFS_DIR)/tmp
	mkdir -pv $(ROOTFS_DIR)/usr
	ln -svf /proc/self/fd $(ROOTFS_DIR)/dev/fd
	ln -svf /proc/self/fd/2 $(ROOTFS_DIR)/dev/stderr
	ln -svf /proc/self/fd/0 $(ROOTFS_DIR)/dev/stdin
	ln -svf /proc/self/fd/1 $(ROOTFS_DIR)/dev/stdout
	cp -v $(PACKAGES_DIR)/skeleton/etc/group $(ROOTFS_DIR)/etc
	cp -v $(PACKAGES_DIR)/skeleton/etc/hosts $(ROOTFS_DIR)/etc
	cp -v $(PACKAGES_DIR)/skeleton/etc/passwd $(ROOTFS_DIR)/etc
	cp -v $(PACKAGES_DIR)/skeleton/etc/profile $(ROOTFS_DIR)/etc
	cp -v $(PACKAGES_DIR)/skeleton/etc/protocols $(ROOTFS_DIR)/etc
	cp -v $(PACKAGES_DIR)/skeleton/etc/services $(ROOTFS_DIR)/etc
	cp -v $(PACKAGES_DIR)/skeleton/etc/shadow $(ROOTFS_DIR)/etc
	cp -v $(PACKAGES_DIR)/skeleton/etc/inittab $(ROOTFS_DIR)/etc
	ln -svf /proc/self/mounts $(ROOTFS_DIR)/etc/mtab
	mkdir -v $(ROOTFS_DIR)/etc/profile.d
	cp -v $(PACKAGES_DIR)/skeleton/etc/profile.d/umask.sh $(ROOTFS_DIR)/etc/profile.d
	ln -svf /tmp/resolv.conf $(ROOTFS_DIR)/etc/resolv.conf
	mkdir -pv $(ROOTFS_DIR)/usr/bin
	mkdir -pv $(ROOTFS_DIR)/usr/lib
	mkdir -pv $(ROOTFS_DIR)/usr/sbin
	install -d -m 0755 $(ROOTFS_DIR)/bin
	install -d -m 0755 $(ROOTFS_DIR)/sbin
	install -d -m 0755 $(ROOTFS_DIR)/lib
	ln -snf lib $(ROOTFS_DIR)/lib64
	ln -snf lib $(ROOTFS_DIR)/usr/lib64
	sed -i -e 's,@PATH@,"/bin:/sbin:/usr/bin:/usr/sbin",' $(ROOTFS_DIR)/etc/profile
	$(STEP) "skeleton-init-sysv"
	mkdir -pv $(ROOTFS_DIR)/dev/pts
	mkdir -pv $(ROOTFS_DIR)/dev/shm
	ln -svf /tmp/log $(ROOTFS_DIR)/dev/log
	cp -v $(PACKAGES_DIR)/skeleton/etc/fstab $(ROOTFS_DIR)/etc
	mkdir -pv $(ROOTFS_DIR)/var/lib
	ln -svf /tmp $(ROOTFS_DIR)/var/cache
	ln -svf /tmp $(ROOTFS_DIR)/var/lib/misc
	ln -svf /tmp $(ROOTFS_DIR)/var/lock
	ln -svf /tmp $(ROOTFS_DIR)/var/log
	ln -svf /run $(ROOTFS_DIR)/var/run
	ln -svf /tmp $(ROOTFS_DIR)/var/spool
	ln -svf /tmp $(ROOTFS_DIR)/var/tmp
	$(STEP) "ifupdown-scripts"
	mkdir -pv $(ROOTFS_DIR)/etc/network/{if-down.d,if-post-down.d,if-pre-up.d,if-up.d}
	install -Dv -m 0755 $(PACKAGES_DIR)/skeleton/etc/network/if-pre-up.d/wait_iface $(ROOTFS_DIR)/etc/network/if-pre-up.d/wait_iface
	( echo "# interface file auto-generated by QNAS"; echo ; echo "auto lo"; echo "iface lo inet loopback"; ) > $(ROOTFS_DIR)/etc/network/interfaces
	( echo ; echo "auto eth0"; echo "iface eth0 inet dhcp"; echo "  pre-up /etc/network/nfs_check"; echo "  wait-delay 15"; echo "  hostname $$(hostname)"; ) >> $(ROOTFS_DIR)/etc/network/interfaces
	install -m 0755 -Dv $(PACKAGES_DIR)/skeleton/etc/network/nfs_check $(ROOTFS_DIR)/etc/network/nfs_check
	install -Dv -m 0755 $(PACKAGES_DIR)/skeleton/etc/init.d/S40network $(ROOTFS_DIR)/etc/init.d/S40network
	$(STEP) "initscripts"
	mkdir -p  $(ROOTFS_DIR)/etc/init.d
	install -Dv -m 0755 $(PACKAGES_DIR)/skeleton/etc/init.d/* $(ROOTFS_DIR)/etc/init.d/
	$(STEP) "Setting inittab"
	sed -i -e '/# GENERIC_SERIAL$$/s~^.*#~tty1::respawn:/sbin/getty -L  tty1 0 vt100 #~' $(ROOTFS_DIR)/etc/inittab
	sed -i -e '/^#.*-o remount,rw \/$$/s~^#\+~~' $(ROOTFS_DIR)/etc/inittab
	$(STEP) "Setting Hostname"
	echo "$(CONFIG_HOSTNAME)" > $(ROOTFS_DIR)/etc/hostname
	sed -i -e '$$a \127.0.1.1\t$(CONFIG_HOSTNAME)' -e '/^127.0.1.1/d' $(ROOTFS_DIR)/etc/hosts
	echo "Welcome to QNAS" > $(ROOTFS_DIR)/etc/issue
	sed -i -e s,^root:[^:]*:,root:"`$(TOOLS_DIR)/bin/mkpasswd -m "sha-512" "$(CONFIG_PASSWORD)"`":, $(ROOTFS_DIR)/etc/shadow
	grep -qsE '^/bin/sh$$' $(ROOTFS_DIR)/etc/shells || echo "/bin/sh" >> $(ROOTFS_DIR)/etc/shells
	( \
		echo "NAME=QNAS"; \
		echo "VERSION=2019.02.1"; \
		echo "ID=QNAS"; \
		echo "VERSION_ID=2019.02.1"; \
		echo "PRETTY_NAME=\"QNAS 2019.02.1\"" \
	) >  $(ROOTFS_DIR)/usr/lib/os-release
	ln -sf ../usr/lib/os-release $(ROOTFS_DIR)/etc
